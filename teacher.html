<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Professor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      margin:0;
      background:#f4f6fa;
    }
    header{
      background:#1f2937;
      color:white;
      padding:16px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h2{ margin:0; font-size:1.4rem; }
    header button{
      background:#ef4444;
      border:none;
      color:white;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
    }
    main{ padding:20px; }

    .actions{
      margin-bottom:14px;
      display:flex;
      gap:10px;
    }
    .actions button{
      background:#2563eb;
      color:white;
      border:none;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
    }

    table{
      width:100%;
      border-collapse:collapse;
      background:white;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
      border-radius:10px;
      overflow:hidden;
    }
    th, td{
      padding:12px;
      border-bottom:1px solid #e5e7eb;
      font-size:.95rem;
    }
    th{
      background:#f1f5f9;
      font-weight:bold;
    }
    tr{
      cursor:pointer;
    }
    tr:hover{
      background:#f9fafb;
    }
    .ok{ color:#15803d; font-weight:bold; }
    .bad{ color:#b91c1c; font-weight:bold; }

    .loading{
      text-align:center;
      font-size:1.1rem;
      color:#555;
      margin-top:40px;
    }
  </style>
</head>

<body>

<header>
  <h2>Painel do Professor</h2>
  <button id="logoutBtn">Logout</button>
</header>

<main>

  <div class="actions">
    <button id="exportBtn">Exportar CSV</button>
    <button onclick="location.reload()">Atualizar</button>
  </div>

  <div id="loading" class="loading">Carregando alunos…</div>

  <table id="studentsTable" style="display:none">
    <thead>
      <tr>
        <th>Aluno</th>
        <th>CPF</th>
        <th>Progresso</th>
        <th>Média</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="studentsBody"></tbody>
  </table>

</main>

<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCr81cMa2T_iZmxy2tNOjYydSnrs3aSmtk",
  authDomain: "jogo-digitacao.firebaseapp.com",
  projectId: "jogo-digitacao",
  storageBucket: "jogo-digitacao.firebasestorage.app",
  messagingSenderId: "903019411681",
  appId: "1:903019411681:web:ea572018fb9913ca2f9fa0"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= AUTH FLOW ================= */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  try {
    const snap = await db.collection("users").doc(user.uid).get();
    if (!snap.exists || snap.data().role !== "teacher") {
      location.href = "game.html";
      return;
    }

    loadStudents();

  } catch (err) {
    console.error(err);
    alert("Erro ao validar professor");
    location.href = "index.html";
  }
});

/* ================= LOAD STUDENTS ================= */
let studentsCache = [];

async function loadStudents(){
  const body = document.getElementById("studentsBody");
  const table = document.getElementById("studentsTable");
  const loading = document.getElementById("loading");

  const usersSnap = await db.collection("users").get();
  studentsCache = [];
  body.innerHTML = "";

  for (const doc of usersSnap.docs) {
    const u = doc.data();
    if (u.role !== "student") continue;

    const uid = doc.id;

    const progressSnap = await db.collection("progress").doc(uid).get();
    const gradesSnap = await db.collection("grades").doc(uid).get();

    const progress = progressSnap.exists
      ? (progressSnap.data().difficultyIndex * 8 + progressSnap.data().currentPhaseIndex + 1)
      : 0;

    const avg = gradesSnap.exists ? gradesSnap.data().average : 0;
    const approved = gradesSnap.exists ? gradesSnap.data().approved : false;

    studentsCache.push({
      nome: u.nome,
      cpf: u.cpf,
      progresso: progress,
      media: avg,
      status: approved ? "APROVADO" : "EM ANDAMENTO"
    });

    const tr = document.createElement("tr");
    tr.onclick = () => {
      window.location.href = `student.html?uid=${uid}`;
    };

    tr.innerHTML = `
      <td>${u.nome}</td>
      <td>${u.cpf}</td>
      <td>${progress} / 24</td>
      <td>${avg}%</td>
      <td class="${approved ? "ok" : "bad"}">
        ${approved ? "APROVADO" : "EM ANDAMENTO"}
      </td>
    `;

    body.appendChild(tr);
  }

  loading.style.display = "none";
  table.style.display = "table";
}

/* ================= EXPORT CSV ================= */
document.getElementById("exportBtn").onclick = () => {
  if (!studentsCache.length) return;

  const header = ["Nome","CPF","Progresso","Média","Status"];
  const rows = studentsCache.map(s =>
    `"${s.nome}","${s.cpf}","${s.progresso}/24","${s.media}%","${s.status}"`
  );

  const csv = [header.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "alunos.csv";
  link.click();
};

/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").onclick = async () => {
  await auth.signOut();
  location.href = "index.html";
};
</script>

</body>
</html>
