<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jogo de Digita√ß√£o (Firebase)</title>

  <!-- Firebase SDKs (Compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg-color:#e6f2ff;
      --text-color:#333;
      --success-color:#d4edda;
      --error-color:#f8d7da;
      --primary-btn:#4CAF50;
      --secondary-btn:#FF9800;
      --danger-btn:#d32f2f;
      --panel-bg:#ffffffcc;
    }

    body{
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      text-align:center;
      margin:0;
      display:flex;
      flex-direction:column;
      height:100vh;
      transition: background-color .25s;
    }

    body.flash-green{ background-color: var(--success-color); }
    body.flash-red{ background-color: var(--error-color); }

    header{
      padding: 18px;
      background:white;
      box-shadow:0 2px 5px rgba(0,0,0,.1);
      position: relative;
    }

    h2{ margin: 8px 0; }

    .meta-row{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:8px;
      color:#555;
      font-size:1.05rem;
    }

    .pill{
      background:#f3f6ff;
      border:1px solid #d9e3ff;
      padding:6px 10px;
      border-radius:999px;
    }

    .progress-container{
      width: 88%;
      max-width: 740px;
      height: 18px;
      background:#ddd;
      border-radius: 10px;
      margin: 10px auto;
      overflow:hidden;
    }

    .progress-bar{
      height:100%;
      width:0%;
      background:#4CAF50;
      transition: width .22s ease;
    }

    .stars{
      font-size:1.7rem;
      margin-top:8px;
    }

    main{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:18px;
      position:relative;
      overflow-y:auto;
    }

    /* input oculto para Mac/acentos */
    #hidden-input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }

    #feedback-msg{
      font-size:1.25rem;
      font-weight:bold;
      min-height:2.2rem;
      margin: 6px 0 10px;
      color:#555;
    }

    #text-display{
      font-size:3rem;
      letter-spacing:2px;
      background:white;
      padding: 18px 34px;
      border-radius:15px;
      box-shadow:0 4px 10px rgba(0,0,0,.1);
      margin-bottom:16px;
      max-width:92%;
      max-height: 45vh;
      overflow-y:auto;
      text-align:left;
      line-height:1.5;
      cursor:text;
      user-select:none;
      word-wrap: break-word;
    }

    .char{ color:#cfcfcf; }
    .char.correct{ color:#28a745; font-weight:bold; }
    .char.current{
      color:#007bff;
      text-decoration: underline;
      font-weight:bold;
      background:#e6f2ff;
    }

    button{
      font-size:1.35rem;
      padding: 14px 34px;
      background: var(--primary-btn);
      color:white;
      border:none;
      border-radius:10px;
      cursor:pointer;
      box-shadow:0 4px 6px rgba(0,0,0,.2);
      margin:8px;
    }

    #change-text-btn{
      background: var(--secondary-btn);
      display:none;
    }

    .result-box{
      max-width: 900px;
      width: 92%;
      margin-top: 8px;
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      text-align:left;
      display:none;
    }
    .result-box h3{ margin: 6px 0 10px; }
    .result-box .small{ color:#666; font-size: .95rem; }
    .result-box .line{ margin:6px 0; }
    .result-box .ok{ color:#1b7f35; font-weight:bold; }
    .result-box .bad{ color:#b00020; font-weight:bold; }
    .hr{ height:1px; background:#eee; margin:10px 0; }

    /* Painel fixo de sess√£o */
    .session-panel{
  position:absolute;
  right:12px;
  top:12px;
  display:flex;
  flex-direction:column; /* empilha */
  gap:6px;
  align-items:flex-end;
  background: var(--panel-bg);
  backdrop-filter: blur(6px);
  padding:10px 12px;
  border-radius:14px;
  border:1px solid #eaeaea;
  max-width:260px;
}

.session-actions{
  display:flex;
  gap:6px;
}

.session-panel .who{
  font-size:.9rem;
  color:#333;
  background:#f3f6ff;
  border:1px solid #d9e3ff;
  padding:4px 8px;
  border-radius:8px;
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  text-align:right;
}
    .mini-btn{
      font-size: .95rem;
      padding: 8px 10px;
      margin:0;
      border-radius: 10px;
      box-shadow:none;
    }
    #save-exit-btn{ background: var(--secondary-btn); }
    #logout-btn{ background: var(--danger-btn); }

    .loading-overlay{
      position:fixed;
      inset:0;
      background:#00000055;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      color:white;
      font-size:1.2rem;
      display:none;
    }
    .loading-card{
      background:#111;
      padding:16px 18px;
      border-radius:12px;
      width:min(520px, 92%);
      text-align:left;
    }
    .loading-card .small{ color:#ddd; font-size:.95rem; margin-top:6px; }
  </style>
</head>

<body>
<header>
  <div class="session-panel">
  <div class="session-actions">
    <button class="mini-btn" id="save-exit-btn">üíæ Salvar e Sair</button>
    <button class="mini-btn" id="logout-btn">üö™ Logout</button>
  </div>
  <div class="who" id="whoami">Carregando...</div>
</div>

  <h2>
    <span id="difficulty-label">Dificuldade: F√°cil</span> ‚Äî
    Fase <span id="phase-number">1</span>/8
    (<span id="overall-phase">1</span>/24):
    <span id="phase-name">O B√°sico</span>
  </h2>

  <div class="progress-container">
    <div class="progress-bar" id="progress"></div>
  </div>

  <div class="meta-row">
    <span class="pill">Tempo: <strong><span id="time-display">0.0</span>s</strong></span>
    <span class="pill">Erros: <strong><span id="errors-display">0</span></strong></span>
    <span class="pill">Alvo (Confort√°vel): <strong><span id="target-display">0.0</span>s</strong></span>
<span class="pill">Ideal: <strong><span id="ideal-display">0.0</span>s</strong></span>
<span class="pill">R√°pido: <strong><span id="fast-display">0.0</span>s</strong></span>
    <span class="pill">Nota da Fase: <strong><span id="phase-score-display">‚Äî</span>%</strong></span>
  </div>

  <div class="stars" id="stars-display">‚≠ê‚≠ê‚≠ê</div>
</header>

<main>
  <p id="feedback-msg">Carregando sess√£o...</p>

  <input id="hidden-input" type="text" autocomplete="off" spellcheck="false" />

  <div id="text-display">Aguarde...</div>

  <div>
    <button id="action-btn">Come√ßar</button>
    <button id="change-text-btn">Trocar Texto</button>
  </div>

  <div class="result-box" id="final-report">
    <h3>Relat√≥rio Final</h3>
    <div class="line">M√©dia geral: <strong><span id="final-average">0</span>%</strong></div>
    <div class="line small" id="final-status"></div>
    <div class="hr"></div>
    <div class="small" id="final-breakdown"></div>
  </div>
</main>

<div class="loading-overlay" id="loading">
  <div class="loading-card">
    <div><strong>Sincronizando com o Firebase...</strong></div>
    <div class="small" id="loading-msg">Carregando progresso.</div>
  </div>
</div>

<script>
/* =========================================================
   FIREBASE INIT (COLE SUA CONFIG AQUI)
   ========================================================= */
const firebaseConfig = {
  apiKey: "AIzaSyCr81cMa2T_iZmxy2tNOjYydSnrs3aSmtk",
  authDomain: "jogo-digitacao.firebaseapp.com",
  projectId: "jogo-digitacao",
  storageBucket: "jogo-digitacao.firebasestorage.app",
  messagingSenderId: "903019411681",
  appId: "1:903019411681:web:ea572018fb9913ca2f9fa0"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

try {
  firebase.initializeApp(firebaseConfig);
} catch (e) {
  document.body.innerHTML = "<pre style='padding:16px;white-space:pre-wrap'>ERRO ao iniciar Firebase:\n" +
    (e && e.message ? e.message : e) + "\n\nVerifique:\n- scripts <script src=...>\n- firebaseConfig preenchido\n</pre>";
  throw e;
}

/* =========================================================
   UI refs (sess√£o)
   ========================================================= */
const whoami = document.getElementById("whoami");
const saveExitBtn = document.getElementById("save-exit-btn");
const logoutBtn = document.getElementById("logout-btn");
const loadingOverlay = document.getElementById("loading");
const loadingMsg = document.getElementById("loading-msg");

function showLoading(msg){
  loadingMsg.innerText = msg || "Carregando...";
  loadingOverlay.style.display = "flex";
}
function hideLoading(){
  loadingOverlay.style.display = "none";
}

/* =========================================================
   JOGO DE DIGITA√á√ÉO ‚Äî 3 DIFICULDADES + NOTA FINAL + MAC FIX
   + FIREBASE: carrega/salva progresso + notas
   ========================================================= */

/* ---------- util ---------- */
function shuffle(arr){
  let i=arr.length, j;
  while(i){
    j = Math.floor(Math.random()*i--);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function fmt1(n){ return (Math.round(n*10)/10).toFixed(1); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function totalCharsOfItems(items){ return items.reduce((acc,s)=>acc+(s? s.length:0),0); }

/* ---------- pools ---------- */
const poolVowels = ["A","E","I","O","U"];
const poolConsonants = ["B","C","√á","D","F","G","H","J","K","L","M","N","P","Q","R","S","T","V","X","Z","W","Y"];

const poolSyllables = [
  "BA","BE","BI","BO","BU","CA","CE","CI","CO","CU","DA","DE","DI","DO","DU",
  "FA","FE","FI","FO","FU","GA","GE","GI","GO","GU","LA","LE","LI","LO","LU",
  "MA","ME","MI","MO","MU","NA","NE","NI","NO","NU","PA","PE","PI","PO","PU",
  "RA","RE","RI","RO","RU","SA","SE","SI","SO","SU","TA","TE","TI","TO","TU",
  "VA","VE","VI","VO","VU","XA","XE","XI","XO","XU","√áA","√áO","√áU"
];

const poolShortWords = [
  "PAI","M√ÉE","V√ì","V√î","TIA","TIO","BEM","MAL","SIM","N√ÉO","SOL","LUA","DIA","PAZ","LUZ","MAR","COR",
  "F√â","P√ÉO","S√ÉO","C√âU","M√ÉO","P√â","CH√Å","S√ì","J√Å","N√â","T√Å","P√î","D√ä","V√ä","L√ä","N√ìS","ELA","ELE",
  "C√ÉO","G√ÅS","RUA","RIO","VOZ","FLOR","SAL","MEL","BOM","BOA","FIM","TREM","LEVE","FORTE",
  "AQUI","ALI","ISSO","TUDO","HOJE","AMANH√É","ONTEM"
];

const poolMediumWords = [
  "MESA","CASA","BOLO","CAF√â","GATO","RATO","DOCE","√ÅGUA","FOGO","TERRA","VENTO","LIVRO","LETRA","TEMPO","NOITE",
  "MANH√É","TARDE","AMOR","SA√öDE","FOR√áA","F√ÅCIL","DIF√çCIL","PR√ÅTICA","M√öSICA","JANELA","PORTA","CHAVE","ESCOLA",
  "AMIGO","AMIGA","CIDADE","PRA√áA","PONTE","CARRO","√îNIBUS","AVI√ÉO","PRAIA","ILHA","FAM√çLIA","VIAGEM","COZINHA",
  "QUARTO","SALA","JARDIM","SORRISO","RISADA","CORRER","ANDAR","PULAR","NADAR","BRINCAR","JOGAR","ESTUDAR",
  "TRABALHO","SONHO","VIT√ìRIA","DERROTA","CADERNO","L√ÅPIS","CANETA","TECLADO","TELA","SENHA","ONLINE","D√öVIDA",
  "RESPOSTA","CORA√á√ÉO","EMO√á√ÉO","RAZ√ÉO","HIST√ìRIA","MEM√ìRIA","CULTURA","CI√äNCIA","F√çSICA","QU√çMICA","R√ÅPIDO",
  "LENTO","QUENTE","FRIO","√ìTIMO","√öTIL","PRESSA","CALMA"
];

const poolLongWords = [
  "CACHORRO","MERCADO","TELEFONE","COMPUTADOR","INTERNET","TRABALHADOR","NATUREZA","ESPERAN√áA","FELICIDADE","AMIZADE",
  "RESPONS√ÅVEL","CONFIAN√áA","CONHECIMENTO","APRENDIZADO","DESAFIO","CONCENTRA√á√ÉO","DISCIPLINA","PERSIST√äNCIA",
  "ORGANIZA√á√ÉO","CRIATIVIDADE","COMUNICA√á√ÉO","ATEN√á√ÉO","PRODUTIVIDADE","EXPERI√äNCIA","INSPIRA√á√ÉO",
  "PROGRAMA√á√ÉO","JAVASCRIPT","DESENVOLVIMENTO","TECNOLOGIA","INFORMA√á√ÉO","CONEX√ÉO","ALGORITMO","ESTRUTURA",
  "UNIVERSIDADE","BIBLIOTECA","LABORAT√ìRIO","ELETRICIDADE","ENGENHARIA","MATEM√ÅTICA","ESTAT√çSTICA","PESQUISA",
  "RESPIRA√á√ÉO","NUTRI√á√ÉO","EXERC√çCIO","CONDICIONAMENTO","SUPERA√á√ÉO","MOTIVA√á√ÉO",
  "BRASILEIRO","PORTUGU√äS","ACENTUA√á√ÉO","ORTOGRAFIA","GRAM√ÅTICA","VOCABUL√ÅRIO",
  "IMPRESSIONANTE","INACREDIT√ÅVEL","EXTRAORDIN√ÅRIO","MARAVILHOSO","SURPREENDENTE",
  "INDEPEND√äNCIA","DEMOCRACIA","DIVERSIDADE","INCLUS√ÉO","COLABORA√á√ÉO",
  "RELACIONAMENTO","COMPREENS√ÉO","SENSIBILIDADE","GENEROSIDADE"
];

const poolPhrases = [
  "Bom dia! Tudo bem com voc√™?",
  "Hoje eu tomei um caf√© bem forte.",
  "A pr√°tica leva √† perfei√ß√£o, n√£o desista!",
  "Voc√™ consegue: foco, calma e precis√£o.",
  "Amanh√£ cedo eu vou √† escola.",
  "O c√©u est√° lindo e o vento est√° leve.",
  "Pegue a chave, feche a porta e venha.",
  'Minha av√≥ disse: "com f√©, tudo melhora".',
  "Eu n√£o quero pressa; quero const√¢ncia.",
  "Olhe pela janela: que paisagem incr√≠vel!",
  "Voc√™ j√° digitou com aten√ß√£o hoje?",
  "A m√∫sica acalma o cora√ß√£o e melhora o humor.",
  "Respire fundo, relaxe os ombros e continue.",
  "Se errar, tudo bem: tente outra vez.",
  "O cachorro latiu alto quando o port√£o abriu.",
  "Eu gostei do p√£o com manteiga e ch√° quente.",
  "A ci√™ncia explica, mas a curiosidade guia.",
  "√Äs vezes, o dif√≠cil vira f√°cil com treino.",
  "Digite devagar no come√ßo e acelere depois.",
  "Concentra√ß√£o √© fazer uma coisa de cada vez.",
  "A internet nos conecta, mas a gentileza aproxima.",
  "Voc√™ √© mais forte do que pensa!",
  "Hoje eu vou estudar programa√ß√£o com calma.",
  "Organiza√ß√£o e disciplina ajudam todos os dias."
];

const literaryTexts = [
  "Marcela amou-me durante quinze meses e onze contos de r√©is; nada menos.",
  "O poeta √© um fingidor. Finge t√£o completamente que chega a fingir que √© dor a dor que deveras sente.",
  "Renda-se, como eu me rendi. Mergulhe no que voc√™ n√£o conhece como eu mergulhei.",
  "O correr da vida embrulha tudo. A vida √© assim: esquenta e esfria, aperta e da√≠ afrouxa.",
  "O sertanejo √©, antes de tudo, um forte. N√£o tem o raquitismo exaustivo dos mesti√ßos.",
  "Tudo vale a pena se a alma n√£o √© pequena. Quem quer passar al√©m do Bojador tem que passar al√©m da dor.",
  "As pessoas n√£o s√£o m√°s, elas s√≥ est√£o perdidas. O tempo √© o melhor autor; sempre encontra um final perfeito."
];

/* ---------- dificuldades ---------- */
const difficulties = [
  { key:"easy",   label:"F√°cil",   picks:{ consonants:12, syllables:20, short:28, medium:24, long:18, phrases:10 }, secPerChar:0.22, timeGraceMultiplier:1.25, strictFromPhase2:false },
  { key:"medium", label:"M√©dio",   picks:{ consonants:16, syllables:26, short:36, medium:32, long:24, phrases:14 }, secPerChar:0.18, timeGraceMultiplier:1.15, strictFromPhase2:false },
  { key:"hard",   label:"Dif√≠cil", picks:{ consonants:18, syllables:30, short:42, medium:38, long:28, phrases:16 }, secPerChar:0.14, timeGraceMultiplier:1.08, strictFromPhase2:true  }
];
  const idealDisplay = document.getElementById("ideal-display");
const fastDisplay  = document.getElementById("fast-display");

/* ---------- DOM ---------- */
const textDisplay = document.getElementById("text-display");
const hiddenInput = document.getElementById("hidden-input");
const feedbackMsg = document.getElementById("feedback-msg");
const actionBtn = document.getElementById("action-btn");
const changeTextBtn = document.getElementById("change-text-btn");
const progress = document.getElementById("progress");
const starsDisplay = document.getElementById("stars-display");
const phaseNumber = document.getElementById("phase-number");
const overallPhase = document.getElementById("overall-phase");
const phaseName = document.getElementById("phase-name");
const difficultyLabel = document.getElementById("difficulty-label");
const timeDisplay = document.getElementById("time-display");
const errorsDisplay = document.getElementById("errors-display");
const targetDisplay = document.getElementById("target-display");
const phaseScoreDisplay = document.getElementById("phase-score-display");
const finalReport = document.getElementById("final-report");
const finalAverage = document.getElementById("final-average");
const finalStatus = document.getElementById("final-status");
const finalBreakdown = document.getElementById("final-breakdown");

/* ---------- estado ---------- */
let currentUser = null;
let userProfile = null;

let difficultyIndex = 0;     // 0..2
let currentPhaseIndex = 0;   // 0..7
let currentWordIndex = 0;
let currentText = "";
let charIndex = 0;
let errors = 0;
let isPlaying = false;

let phases = [];           // plano atual (8 fases)
let phasePlanSaved = null; // objeto serializ√°vel do plano atual

// timer
let phaseStartMs = 0;
let phaseElapsed = 0;
let targetSeconds = 0;
let timerInterval = null;

// notas do curso (24 fases)
let phaseGrades = [];      // array com 24 itens acumulados

// MAC FIX
let isComposing = false;

// Sync
let dirty = false;         // h√° mudan√ßas n√£o salvas
let autosaveInterval = null;

/* =========================================================
   FIRESTORE helpers
   ========================================================= */
function docRef(col){ return db.collection(col).doc(currentUser.uid); }

async function loadUserProfile(){
  const snap = await docRef("users").get();
  return snap.exists ? snap.data() : null;
}

async function loadProgress(){
  const snap = await docRef("progress").get();
  return snap.exists ? snap.data() : null;
}

async function loadGrades(){
  const snap = docRef("grades").get();
  const s = await snap;
  return s.exists ? s.data() : null;
}

async function saveProgress(reason){
  if (!currentUser) return;
  // serializa estado do jogo (inclui o plano das fases para continuar igual)
  const payload = {
    difficultyIndex,
    currentPhaseIndex,
    currentWordIndex,
    charIndex,
    currentText,
    // plano das fases (j√° embaralhado/recortado)
    phasePlan: phasePlanSaved,
    // notas acumuladas (opcional salvar aqui tamb√©m, mas mantemos em grades)
    updatedAt: serverTimestamp(),
    lastSaveReason: reason || "autosave"
  };

  await docRef("progress").set(payload, { merge: true });
  dirty = false;
}

async function saveGrades(){
  if (!currentUser) return;

  const total = phaseGrades.reduce((acc,p)=>acc+(p?.score ?? 0), 0);
  const count = phaseGrades.filter(Boolean).length;
  const avg = count ? Math.round(total / count) : 0;
  const approved = avg >= 70;

  await docRef("grades").set({
    phases: phaseGrades,
    average: avg,
    approved,
    updatedAt: serverTimestamp()
  }, { merge: true });
}

function markDirty(){
  dirty = true;
}

/* =========================================================
   constru√ß√£o fases (e serializa√ß√£o do plano)
   ========================================================= */
function buildPhasesForDifficulty(diff){
  // gera um plano determin√≠stico desta sess√£o (random, mas fixo enquanto n√£o mudar)
  const plan = {
    name: diff.label,
    createdAt: Date.now(),
    phases: [
      { name:"Vogais", type:"list", items: shuffle([...poolVowels]) },
      { name:"Consoantes", type:"list", items: shuffle([...poolConsonants]).slice(0, Math.min(diff.picks.consonants, poolConsonants.length)) },
      { name:"S√≠labas", type:"list", items: shuffle([...poolSyllables]).slice(0, Math.min(diff.picks.syllables, poolSyllables.length)) },
      { name:"Palavras Curtas", type:"list", items: shuffle([...poolShortWords]).slice(0, Math.min(diff.picks.short, poolShortWords.length)) },
      { name:"Palavras M√©dias", type:"list", items: shuffle([...poolMediumWords]).slice(0, Math.min(diff.picks.medium, poolMediumWords.length)) },
      { name:"Palavras Longas", type:"list", items: shuffle([...poolLongWords]).slice(0, Math.min(diff.picks.long, poolLongWords.length)) },
      { name:"Frases", type:"list", items: shuffle([...poolPhrases]).slice(0, Math.min(diff.picks.phrases, poolPhrases.length)) },
      { name:"Texto Liter√°rio", type:"final", items: [] }
    ]
  };

  // aplica no runtime
  phasePlanSaved = plan;
  phases = plan.phases;
}

function restorePhasePlan(savedPlan){
  phasePlanSaved = savedPlan;
  phases = savedPlan?.phases || [];
}

/* ---------- UI helpers ---------- */
function setButton(mode, text){
  actionBtn.dataset.mode = mode;
  actionBtn.innerText = text;
  actionBtn.style.display = "inline-block";
}
function hideButton(){ actionBtn.style.display = "none"; }

function resetPhaseStats(){
  errors = 0;
  errorsDisplay.innerText = "0";
  starsDisplay.innerText = "‚≠ê‚≠ê‚≠ê";
  phaseElapsed = 0;
  timeDisplay.innerText = "0.0";
  targetDisplay.innerText = "0.0";
  phaseScoreDisplay.innerText = "‚Äî";
}

function overallPhaseNumber(){
  return (difficultyIndex * 8) + (currentPhaseIndex + 1); // 1..24
}

function updateHeader(){
  const diff = difficulties[difficultyIndex];
  difficultyLabel.innerText = `Dificuldade: ${diff.label}`;
  phaseNumber.innerText = String(currentPhaseIndex + 1);
  overallPhase.innerText = String(overallPhaseNumber());
  phaseName.innerText = phases[currentPhaseIndex]?.name || "‚Äî";
}

/* ---------- timer/target ---------- */
function startTimerAndTarget(){
  const diff = difficulties[difficultyIndex];
  const phase = phases[currentPhaseIndex];

  let totalChars = 0;
  if (phase?.type === "list") totalChars = totalCharsOfItems(phase.items);

  targetSeconds = totalChars > 0 ? totalChars * diff.secPerChar : 0;
  targetDisplay.innerText = fmt1(targetSeconds);

  phaseStartMs = performance.now();
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!isPlaying) return;
    phaseElapsed = (performance.now() - phaseStartMs)/1000;
    timeDisplay.innerText = fmt1(phaseElapsed);
  }, 100);
}

function stopTimer(){
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  phaseElapsed = phaseStartMs ? (performance.now() - phaseStartMs)/1000 : 0;
  timeDisplay.innerText = fmt1(phaseElapsed);
}

/* ---------- feedback visual ---------- */
function flashScreen(type){
  document.body.classList.add(`flash-${type}`);
  setTimeout(() => document.body.classList.remove(`flash-${type}`), 220);
}

/* ---------- stars + NOTA ---------- */
function calculateStarsWithTime(err, elapsed, target){
  const diff = difficulties[difficultyIndex];
  const errorLimits = diff.key === "easy"
    ? {three:2, two:6}
    : diff.key === "medium"
      ? {three:1, two:4}
      : {three:0, two:2};

  let byErrors = 1;
  if (err <= errorLimits.three) byErrors = 3;
  else if (err <= errorLimits.two) byErrors = 2;

  let byTime = 3;
  if (target > 0){
    const grace = target * diff.timeGraceMultiplier;
    if (elapsed <= target) byTime = 3;
    else if (elapsed <= grace) byTime = 2;
    else byTime = 1;
  }

  const finalStars = Math.min(byErrors, byTime);
  if (finalStars === 3) return "‚≠ê‚≠ê‚≠ê Excelente!";
  if (finalStars === 2) return "‚≠ê‚≠ê Muito bom!";
  return "‚≠ê Continue praticando!";
}

function computePhaseScore(err, elapsed, target){
  const diff = difficulties[difficultyIndex];

  const errCost = diff.key === "easy" ? 6 : (diff.key === "medium" ? 10 : 14);
  let score = 100 - (err * errCost);

  if (target > 0){
    const ratio = elapsed / target;
    if (ratio > 1){
      const k = diff.key === "easy" ? 0.40 : (diff.key === "medium" ? 0.50 : 0.60);
      score -= (ratio - 1) * 100 * k;
    }
  }

  score = clamp(score, 0, 100);
  return Math.round(score);
}

/* ---------- regras de compara√ß√£o ---------- */
function isCharCorrect(typedChar, expectedChar){
  const diff = difficulties[difficultyIndex];
  const phaseNum = currentPhaseIndex + 1; // 1..8
  const isFinal = (phases[currentPhaseIndex]?.type === "final");

  if (isFinal) return typedChar === expectedChar;
  if (diff.strictFromPhase2 && phaseNum >= 2) return typedChar === expectedChar;
  return typedChar.toLowerCase() === expectedChar.toLowerCase();
}

/* ---------- render ---------- */
function renderText(text){
  textDisplay.innerHTML = "";
  for (let i=0;i<text.length;i++){
    const sp = document.createElement("span");
    sp.innerText = text[i];
    sp.classList.add("char");
    if (i===0) sp.classList.add("current");
    textDisplay.appendChild(sp);
  }
}

function applyCharProgress(){
  // marca como corretos os chars j√° digitados ao restaurar
  const spans = textDisplay.querySelectorAll("span");
  for (let i=0; i<spans.length; i++){
    spans[i].classList.remove("current");
    if (i < charIndex) spans[i].classList.add("correct");
  }
  if (spans[charIndex]) spans[charIndex].classList.add("current");
}

function updateProgressUI(){
  const phase = phases[currentPhaseIndex];
  if (phase?.type === "list"){
    const total = phase.items.length || 1;
    progress.style.width = ((currentWordIndex/total)*100) + "%";
  } else {
    progress.style.width = currentText ? ((charIndex/currentText.length)*100) + "%" : "0%";
  }
}

function updateFinalProgress(){
  if (phases[currentPhaseIndex]?.type === "final" && currentText){
    progress.style.width = ((charIndex/currentText.length)*100) + "%";
  }
}

/* ---------- carregar item ---------- */
function loadItem(){
  const phase = phases[currentPhaseIndex];
  if (!phase) return;

  if (phase.type === "final"){
    loadFinalText();
    return;
  }

  currentText = phase.items[currentWordIndex];
  charIndex = 0;
  renderText(currentText);
  hiddenInput.value = "";
}

function loadFinalText(){
  const diff = difficulties[difficultyIndex];

  // se j√° existe currentText por restore, s√≥ renderiza
  if (!currentText || currentText.length < 5){
    const idx = Math.floor(Math.random() * literaryTexts.length);
    currentText = literaryTexts[idx];
  }

  renderText(currentText);

  targetSeconds = currentText.length * diff.secPerChar;
  targetDisplay.innerText = fmt1(targetSeconds);

  changeTextBtn.style.display = "inline-block";
  hiddenInput.focus();
  hiddenInput.value = "";
}

/* ---------- controle ---------- */
function startGame(){
  // inicia do estado atual (pode ser restore)
  finalReport.style.display = "none";
  feedbackMsg.innerText = "Digite a letra sublinhada.";
  changeTextBtn.style.display = "none";
  textDisplay.style.textAlign = "left";

  resetPhaseStats();
  hideButton();

  isPlaying = true;
  hiddenInput.focus();

  startTimerAndTarget();

  // se n√£o tiver currentText, carrega
  if (!currentText) loadItem();
  else {
    renderText(currentText);
    applyCharProgress();
  }
  updateHeader();
  updateProgressUI();

  markDirty();
}

function continueToNextPhase(){
  finalReport.style.display = "none";
  feedbackMsg.innerText = "Digite a letra sublinhada.";
  changeTextBtn.style.display = "none";
  textDisplay.style.textAlign = "left";

  resetPhaseStats();
  hideButton();

  isPlaying = true;
  hiddenInput.focus();

  updateHeader();
  startTimerAndTarget();
  loadItem();
  updateProgressUI();

  markDirty();
}

/* ---------- bot√µes ---------- */
actionBtn.addEventListener("click", async () => {
  const mode = actionBtn.dataset.mode || "start";
  if (mode === "start") startGame();
  else if (mode === "next") continueToNextPhase();
  else if (mode === "retry") {
    // reprova√ß√£o: reinicia tentativa do zero
    await resetProgressInFirestore();
    location.reload();
  } else if (mode === "restart") location.reload();
});
changeTextBtn.addEventListener("click", () => { currentText = ""; loadFinalText(); markDirty(); });

textDisplay.addEventListener("click", () => hiddenInput.focus());
document.body.addEventListener("click", () => { if (isPlaying) hiddenInput.focus(); });

document.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !isPlaying){
    const mode = actionBtn.dataset.mode || "start";
    if (mode === "start") startGame();
    else if (mode === "next") continueToNextPhase();
    else if (mode === "retry") location.reload();
  }
});

/* =========================================================
   ‚úÖ MAC FIX (dead keys)
   ========================================================= */
function processTypedText(text){
  if (!text) return;
  for (const ch of text){
    if (!isPlaying) break;
    processTypedChar(ch);
  }
}

function processTypedChar(typedChar){
  const expectedChar = currentText[charIndex];
  const spans = textDisplay.querySelectorAll("span");
  if (!expectedChar || !spans[charIndex]) return;

  if (isCharCorrect(typedChar, expectedChar)){
    spans[charIndex].classList.remove("current");
    spans[charIndex].classList.add("correct");
    flashScreen("green");

    charIndex++;
    updateFinalProgress();
    markDirty();

    if (charIndex === currentText.length){
      const phase = phases[currentPhaseIndex];

      if (phase.type === "final"){
        finishPhase();
      } else {
        currentWordIndex++;
        if (currentWordIndex >= phase.items.length){
          finishPhase();
        } else {
          isPlaying = false;
          setTimeout(() => {
            loadItem();
            updateProgressUI();
            isPlaying = true;
            markDirty();
          }, 220);
        }
      }
    } else {
      spans[charIndex].classList.add("current");
      spans[charIndex].scrollIntoView({ behavior:"smooth", block:"center" });
    }

  } else {
    errors++;
    errorsDisplay.innerText = String(errors);
    flashScreen("red");
    markDirty();

    if (phases[currentPhaseIndex].type === "final"){
      feedbackMsg.innerText = "Aten√ß√£o a mai√∫sculas, min√∫sculas e acentos!";
    } else if (difficulties[difficultyIndex].key === "hard" && (currentPhaseIndex + 1) >= 2){
      feedbackMsg.innerText = "No Dif√≠cil, a partir da Fase 2 √© exato (mai√∫sculas e acentos)!";
    }
  }
}

hiddenInput.addEventListener("compositionstart", () => { isComposing = true; });

hiddenInput.addEventListener("compositionend", (event) => {
  isComposing = false;
  if (!isPlaying){ hiddenInput.value = ""; return; }
  const composed = (event.data ?? hiddenInput.value);
  processTypedText(composed);
  hiddenInput.value = "";
});

hiddenInput.addEventListener("input", (event) => {
  if (!isPlaying){ hiddenInput.value = ""; return; }
  if (event.isComposing || isComposing || event.inputType === "insertCompositionText") return;
  const data = (event.data ?? hiddenInput.value);
  processTypedText(data);
  hiddenInput.value = "";
});

/* ---------- FIREBASE: reset progress (reprova√ß√£o) ---------- */
async function resetProgressInFirestore(){
  if (!currentUser) return;
  await docRef("progress").set({
    difficultyIndex: 0,
    currentPhaseIndex: 0,
    currentWordIndex: 0,
    charIndex: 0,
    currentText: "",
    phasePlan: null,
    updatedAt: serverTimestamp()
  }, { merge: false });

  await docRef("grades").set({
    phases: [],
    average: 0,
    approved: false,
    updatedAt: serverTimestamp()
  }, { merge: false });
}

/* ---------- FINALIZAR FASE + guardar nota + salvar firebase ---------- */
async function finishPhase(){
  stopTimer();
  isPlaying = false;
  progress.style.width = "100%";

  const starsText = calculateStarsWithTime(errors, phaseElapsed, targetSeconds);
  starsDisplay.innerText = starsText;

  const phaseScore = computePhaseScore(errors, phaseElapsed, targetSeconds);
  phaseScoreDisplay.innerText = String(phaseScore);

  // garante array de 24 posi√ß√µes
  if (!Array.isArray(phaseGrades)) phaseGrades = [];
  const idxOverall = overallPhaseNumber() - 1; // 0..23

  phaseGrades[idxOverall] = {
    overallPhase: overallPhaseNumber(),
    difficulty: difficulties[difficultyIndex].label,
    phase: `${currentPhaseIndex + 1}/8 - ${phases[currentPhaseIndex].name}`,
    score: phaseScore,
    starsText,
    elapsed: Math.round(phaseElapsed * 10) / 10,
    target: Math.round(targetSeconds * 10) / 10,
    errors,
    savedAt: Date.now()
  };

  // avan√ßa fase
  currentPhaseIndex++;
  currentWordIndex = 0;
  charIndex = 0;
  currentText = "";
  changeTextBtn.style.display = "none";

  // salva notas e progresso
  try{
    showLoading("Salvando notas e progresso...");
    await saveGrades();
    await saveProgress("finishPhase");
  } finally {
    hideLoading();
  }

  // terminou 8 fases desta dificuldade?
  if (currentPhaseIndex >= phases.length){
    difficultyIndex++;

    // terminou as 3 dificuldades = terminou o curso (24 fases)
    if (difficultyIndex >= difficulties.length){
      showFinalGradeAndDecide();
      return;
    }

    // pr√≥xima dificuldade: volta para fase 1 e gera novo plano
    currentPhaseIndex = 0;
    currentWordIndex = 0;
    charIndex = 0;
    currentText = "";

    buildPhasesForDifficulty(difficulties[difficultyIndex]);
    updateHeader();

    feedbackMsg.innerText = `Dificuldade conclu√≠da! Agora: ${difficulties[difficultyIndex].label}.`;
    textDisplay.innerHTML = "üî• Nova dificuldade! Clique em Pr√≥xima Fase.";
    textDisplay.style.textAlign = "center";

    setButton("next", "Pr√≥xima Fase");
    markDirty();
    await saveProgress("newDifficulty");
    return;
  }

  updateHeader();
  feedbackMsg.innerText = "Fase conclu√≠da! " + starsText;
  textDisplay.innerHTML = "üåü";
  textDisplay.style.textAlign = "center";
  setButton("next", "Pr√≥xima Fase");

  markDirty();
}

/* ---------- RELAT√ìRIO FINAL: m√©dia >=70 passa, <70 reinicia ---------- */
function showFinalGradeAndDecide(){
  const total = phaseGrades.reduce((acc, p) => acc + (p?.score ?? 0), 0);
  const count = phaseGrades.filter(Boolean).length;
  const avg = count ? (total / count) : 0;
  const avgRound = Math.round(avg);

  finalAverage.innerText = String(avgRound);

  const byDiff = {};
  for (const p of phaseGrades){
    if (!p) continue;
    if (!byDiff[p.difficulty]) byDiff[p.difficulty] = [];
    byDiff[p.difficulty].push(p.score);
  }

  const lines = [];
  for (const key of Object.keys(byDiff)){
    const arr = byDiff[key];
    const a = arr.reduce((x,y)=>x+y,0)/arr.length;
    lines.push(`‚Ä¢ ${key}: ${Math.round(a)}%`);
  }

  finalBreakdown.innerHTML =
    `<div class="line"><strong>Resumo por dificuldade:</strong></div>` +
    lines.map(s => `<div class="line">${s}</div>`).join("") +
    `<div class="hr"></div>` +
    `<div class="line small">Regra: m√©dia ‚â• 70% = aprovado. Abaixo de 70% = reinicia a atividade.</div>`;

  finalReport.style.display = "block";

  if (avg >= 70){
    feedbackMsg.innerText = "Aprovado! Voc√™ pode ir embora da aula. ‚úÖ";
    textDisplay.innerHTML = "üèÜ‚úÖ PARAB√âNS! ‚úÖüèÜ";
    textDisplay.style.textAlign = "center";
    finalStatus.innerHTML = `<span class="ok">Status: APROVADO</span> ‚Äî M√©dia ‚â• 70%.`;

    setButton("restart", "Jogar de Novo (Opcional)");
  } else {
    feedbackMsg.innerText = "Nota abaixo de 70%. Voc√™ deve reiniciar a atividade. ‚ùå";
    textDisplay.innerHTML = "‚ùå REPROVADO ‚ùå<br><span style='font-size:1.4rem;color:#555'>Reinicie e tente novamente.</span>";
    textDisplay.style.textAlign = "center";
    finalStatus.innerHTML = `<span class="bad">Status: REPROVADO</span> ‚Äî M√©dia < 70%.`;

    setButton("retry", "Reiniciar");
  }
}

/* =========================================================
   ‚úÖ Sess√£o Firebase + Restore do progresso
   ========================================================= */
async function initAfterAuth(user){
  currentUser = user;

  showLoading("Carregando perfil...");
  userProfile = await loadUserProfile();

  if (!userProfile){
    // se n√£o existir, manda pro login (isso n√£o deveria acontecer)
    hideLoading();
    alert("Perfil n√£o encontrado. Volte ao login.");
    window.location.href = "index.html";
    return;
  }

  whoami.innerText = `${userProfile.nome || "Aluno"} (${userProfile.cpf || "CPF"})`;

  // Se for professor, n√£o entra no jogo
  if (userProfile.role === "teacher"){
    hideLoading();
    window.location.href = "teacher.html";
    return;
  }

  showLoading("Carregando progresso...");
  const progressData = await loadProgress();

  showLoading("Carregando notas...");
  const gradesData = await loadGrades();

  // restaura notas
  phaseGrades = (gradesData && Array.isArray(gradesData.phases)) ? gradesData.phases : [];

  // restaura progresso do jogo
  if (progressData && progressData.phasePlan && progressData.phasePlan.phases){
    difficultyIndex = progressData.difficultyIndex ?? 0;
    restorePhasePlan(progressData.phasePlan);

    currentPhaseIndex = progressData.currentPhaseIndex ?? 0;
    currentWordIndex = progressData.currentWordIndex ?? 0;
    charIndex = progressData.charIndex ?? 0;
    currentText = progressData.currentText ?? "";

    // garante limites
    if (difficultyIndex < 0 || difficultyIndex > 2) difficultyIndex = 0;
    if (currentPhaseIndex < 0 || currentPhaseIndex > 7) currentPhaseIndex = 0;

    feedbackMsg.innerText = "Progresso carregado! Clique em ‚ÄúCome√ßar‚Äù para continuar.";
    setButton("start", "Continuar");
  } else {
    // novo aluno: cria plano inicial
    difficultyIndex = 0;
    buildPhasesForDifficulty(difficulties[difficultyIndex]);
    currentPhaseIndex = 0;
    currentWordIndex = 0;
    charIndex = 0;
    currentText = "";

    feedbackMsg.innerText = "Clique em ‚ÄúCome√ßar‚Äù para iniciar!";
    setButton("start", "Come√ßar");
  }

  // UI inicial
  updateHeader();
  textDisplay.innerHTML = "Clique em ‚ÄúCome√ßar‚Äù e digite aqui!";
  textDisplay.style.textAlign = "center";
  hideLoading();

  // autosave peri√≥dico (a cada 20s)
  if (autosaveInterval) clearInterval(autosaveInterval);
  autosaveInterval = setInterval(async () => {
    if (!currentUser) return;
    if (!dirty) return;
    try{
      await saveProgress("interval");
    } catch(e){
      // silencioso para n√£o atrapalhar aula
      console.warn("Autosave falhou:", e?.code || e?.message || e);
    }
  }, 20000);
}

/* Guard de rota: precisa estar logado */
auth.onAuthStateChanged(async (user) => {
  if (!user){
    window.location.href = "index.html";
    return;
  }
  await initAfterAuth(user);
});

/* =========================================================
   Bot√µes de sess√£o: salvar/sair/logout
   ========================================================= */
saveExitBtn.addEventListener("click", async () => {
  if (!currentUser){
    window.location.href = "index.html";
    return;
  }
  try{
    showLoading("Salvando e saindo...");
    await saveGrades();
    await saveProgress("saveExit");
  } finally {
    hideLoading();
  }
  await auth.signOut();
  window.location.href = "index.html";
});

logoutBtn.addEventListener("click", async () => {
  await auth.signOut();
  window.location.href = "index.html";
});

/* =========================================================
   Aviso ao fechar se houver mudan√ßas n√£o salvas
   (n√£o bloqueia fechamento, mas avisa)
   ========================================================= */
window.addEventListener("beforeunload", (e) => {
  if (dirty){
    e.preventDefault();
    e.returnValue = "";
  }
});
</script>
</body>
</html>
