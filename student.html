<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Detalhes do Aluno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      background:#f4f6fa;
      margin:0;
      padding:0;
    }
    header{
      background:#1f2937;
      color:white;
      padding:16px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    header h2{ margin:0; font-size:1.2rem; }
    header .sub { font-size:.9rem; color:#d1d5db; margin-top:4px; }
    header .actions{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }
    header button{
      background:#2563eb;
      border:none;
      color:white;
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      white-space: nowrap;
    }
    header button.secondary{ background:#0ea5e9; }
    main{ padding:20px; }
    .card{
      background:white;
      border-radius:12px;
      padding:16px;
      margin-bottom:18px;
      box-shadow:0 4px 10px rgba(0,0,0,.06);
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    th,td{
      padding:8px;
      border-bottom:1px solid #e5e7eb;
      text-align:center;
      vertical-align: top;
    }
    th{
      background:#f1f5f9;
      font-weight:bold;
    }
    .ok{ color:#15803d; font-weight:bold; }
    .bad{ color:#b91c1c; font-weight:bold; }
    canvas{ max-height:300px; }
    .loading{
      text-align:center;
      font-size:1.1rem;
      margin-top:40px;
      color:#555;
    }
    .errorbox{
      background:#fff;
      border-radius:12px;
      padding:16px;
      box-shadow:0 4px 10px rgba(0,0,0,.06);
      max-width: 900px;
      margin: 18px auto;
      color:#b00020;
      display:none;
      text-align:left;
      white-space: pre-wrap;
    }
    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .pill{
      background:#f3f6ff;
      border:1px solid #d9e3ff;
      padding:6px 10px;
      border-radius:999px;
      font-size:.95rem;
      color:#333;
    }
    .hint{
      color:#666;
      font-size:.9rem;
      margin-top:8px;
    }
  </style>
</head>

<body>

<header>
  <div>
    <h2 id="student-title">Aluno</h2>
    <div class="sub" id="student-sub">Detalhes e gr√°ficos</div>
  </div>

  <div class="actions">
    <button id="exportBtn" class="secondary">üì• Exportar CSV completo</button>
    <button id="backBtn">‚¨Ö Voltar</button>
  </div>
</header>

<main>
  <div id="loading" class="loading">Carregando dados do aluno‚Ä¶</div>
  <div id="errorbox" class="errorbox"></div>

  <div id="content" style="display:none">

    <!-- RESUMO -->
    <div class="card">
      <div class="meta">
        <div class="pill"><strong>CPF:</strong> <span id="cpf"></span></div>
        <div class="pill"><strong>M√©dia:</strong> <span id="avg"></span>%</div>
        <div class="pill"><strong>Status:</strong> <span id="status"></span></div>
      </div>
      <div class="hint">
        Dica: o CSV completo exporta 1 linha por fase (nota, tempo, CPS, precis√£o, erros e targets).
      </div>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="grid">
      <div class="card">
        <h4>Evolu√ß√£o da Nota (Fases 1‚Äì24)</h4>
        <canvas id="scoreChart"></canvas>
      </div>
      <div class="card">
        <h4>Velocidade M√©dia (CPS)</h4>
        <canvas id="speedChart"></canvas>
      </div>
      <div class="card">
        <h4>Precis√£o M√©dia (%)</h4>
        <canvas id="accuracyChart"></canvas>
      </div>
    </div>

    <!-- TABELA -->
    <div class="card">
      <h4>Detalhes por Fase</h4>
      <table>
        <thead>
          <tr>
            <th>Fase</th>
            <th>Dificuldade</th>
            <th>Nota</th>
            <th>Tempo (s)</th>
            <th>CPS</th>
            <th>Precis√£o (%)</th>
            <th>Erros</th>
          </tr>
        </thead>
        <tbody id="phases-body"></tbody>
      </table>
    </div>

  </div>
</main>

<script>
/* ============================
   BOT√ïES
   ============================ */
document.getElementById("backBtn").addEventListener("click", () => history.back());

/* ============================
   FIREBASE INIT
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyCr81cMa2T_iZmxy2tNOjYydSnrs3aSmtk",
  authDomain: "jogo-digitacao.firebaseapp.com",
  projectId: "jogo-digitacao",
  storageBucket: "jogo-digitacao.firebasestorage.app",
  messagingSenderId: "903019411681",
  appId: "1:903019411681:web:ea572018fb9913ca2f9fa0"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ============================
   HELPERS UI
   ============================ */
const loadingEl = document.getElementById("loading");
const contentEl = document.getElementById("content");
const errorBoxEl = document.getElementById("errorbox");

function showError(msg){
  loadingEl.style.display = "none";
  contentEl.style.display = "none";
  errorBoxEl.style.display = "block";
  errorBoxEl.textContent = msg;
}
function showContent(){
  loadingEl.style.display = "none";
  errorBoxEl.style.display = "none";
  contentEl.style.display = "block";
}

/* ============================
   PARAMS
   ============================ */
const params = new URLSearchParams(window.location.search);
const studentUid = params.get("uid");
if (!studentUid){
  showError("Erro: UID do aluno n√£o foi informado.\nVolte ao painel e clique no aluno novamente.");
}

/* ============================
   CHART INSTANCES
   ============================ */
let scoreChartInstance = null;
let speedChartInstance = null;
let accuracyChartInstance = null;

/* ============================
   CACHE para export CSV
   ============================ */
let exportContext = {
  studentUid: "",
  nome: "",
  cpf: "",
  average: 0,
  approved: false,
  phases: []
};

/* ============================
   CSV helpers
   ============================ */
function csvEscape(v){
  if (v === null || v === undefined) return "";
  const s = String(v);
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

function downloadText(filename, text, mime="text/csv;charset=utf-8;"){
  const blob = new Blob([text], { type: mime });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

/* ============================
   Export CSV completo (1 linha por fase)
   ============================ */
document.getElementById("exportBtn").addEventListener("click", () => {
  if (!exportContext.studentUid){
    alert("Ainda carregando dados do aluno.");
    return;
  }

  const { nome, cpf, studentUid, average, approved, phases } = exportContext;
  const status = approved ? "APROVADO" : "EM ANDAMENTO";

  const header = [
    "uid_aluno","nome","cpf","media_geral","status_geral",
    "fase_geral","dificuldade","fase_nome",
    "nota","tempo_s","cps","precisao_pct","erros",
    "target_confortavel_s","target_ideal_s","target_rapido_s","time_tier"
  ];

  const lines = [];
  lines.push(header.join(","));

  // Se n√£o houver fases, exporta s√≥ a ‚Äúcapa‚Äù
  if (!phases || phases.length === 0){
    lines.push([
      csvEscape(studentUid),
      csvEscape(nome),
      csvEscape(cpf),
      csvEscape(average),
      csvEscape(status),
      "", "", "",
      "", "", "", "", "",
      "", "", "", ""
    ].join(","));
    downloadText(`relatorio_${cpf || studentUid}.csv`, lines.join("\n"));
    return;
  }

  for (const p of phases){
    lines.push([
      csvEscape(studentUid),
      csvEscape(nome),
      csvEscape(cpf),
      csvEscape(average),
      csvEscape(status),

      csvEscape(p.overallPhase ?? ""),
      csvEscape(p.difficulty ?? ""),
      csvEscape(p.phase ?? ""),

      csvEscape(p.score ?? ""),
      csvEscape(p.elapsed ?? ""),
      csvEscape(p.cps ?? ""),
      csvEscape(p.accuracyPct ?? ""),
      csvEscape(p.errors ?? ""),

      csvEscape(p.targetComfort ?? ""),
      csvEscape(p.targetIdeal ?? ""),
      csvEscape(p.targetFast ?? ""),
      csvEscape(p.timeTier ?? "")
    ].join(","));
  }

  downloadText(`relatorio_${(cpf || studentUid).replace(/\D/g,'')}.csv`, lines.join("\n"));
});

/* ============================
   AUTH + ROLE GUARD
   ============================ */
auth.onAuthStateChanged(async (user) => {
  if (!studentUid) return;

  if (!user){
    location.href = "index.html";
    return;
  }

  try{
    const teacherDoc = await db.collection("users").doc(user.uid).get();
    if (!teacherDoc.exists || teacherDoc.data().role !== "teacher"){
      location.href = "index.html";
      return;
    }

    await loadStudent();

  } catch (err){
    console.error(err);
    showError("Erro ao validar acesso do professor.\n\nDetalhes:\n" + (err.message || err));
  }
});

/* ============================
   LOAD STUDENT DATA
   ============================ */
async function loadStudent(){
  try{
    const userDoc = await db.collection("users").doc(studentUid).get();
    const gradesDoc = await db.collection("grades").doc(studentUid).get();

    if (!userDoc.exists){
      showError("Aluno n√£o encontrado (users/{uid} n√£o existe).");
      return;
    }
    if (!gradesDoc.exists){
      showError("Este aluno ainda n√£o tem notas salvas (grades/{uid} n√£o existe).\nPe√ßa para ele jogar ao menos 1 fase.");
      return;
    }

    const user = userDoc.data();
    const grades = gradesDoc.data();
    const phases = Array.isArray(grades.phases) ? grades.phases.filter(Boolean) : [];

    document.getElementById("student-title").innerText = user.nome || "Aluno";
    document.getElementById("student-sub").innerText = `UID: ${studentUid}`;
    document.getElementById("cpf").innerText = user.cpf || "-";
    document.getElementById("avg").innerText = grades.average ?? 0;

    document.getElementById("status").innerHTML =
      grades.approved
        ? '<span class="ok">APROVADO</span>'
        : '<span class="bad">EM ANDAMENTO</span>';

    // prepara cache para export
    exportContext = {
      studentUid,
      nome: user.nome || "",
      cpf: user.cpf || "",
      average: grades.average ?? 0,
      approved: !!grades.approved,
      phases
    };

    renderTable(phases);
    renderCharts(phases);

    showContent();

  } catch (err){
    console.error(err);
    showError("Erro ao carregar dados do aluno.\n\nDetalhes:\n" + (err.message || err));
  }
}

/* ============================
   TABLE
   ============================ */
function renderTable(phases){
  const body = document.getElementById("phases-body");
  if (!phases.length){
    body.innerHTML = `<tr><td colspan="7">Sem fases registradas ainda.</td></tr>`;
    return;
  }

  body.innerHTML = phases.map(p => `
    <tr>
      <td>${p.overallPhase ?? "-"}</td>
      <td>${p.difficulty ?? "-"}</td>
      <td>${p.score ?? "-"}</td>
      <td>${p.elapsed ?? "-"}</td>
      <td>${p.cps ?? "-"}</td>
      <td>${p.accuracyPct ?? "-"}</td>
      <td>${p.errors ?? "-"}</td>
    </tr>
  `).join("");
}

/* ============================
   CHARTS
   ============================ */
function renderCharts(phases){
  if (scoreChartInstance) scoreChartInstance.destroy();
  if (speedChartInstance) speedChartInstance.destroy();
  if (accuracyChartInstance) accuracyChartInstance.destroy();

  const labels = phases.map(p => p.overallPhase);
  const scores = phases.map(p => p.score ?? 0);

  // 1) Evolu√ß√£o da Nota
  scoreChartInstance = new Chart(document.getElementById("scoreChart"), {
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"Nota",
        data:scores,
        borderColor:"#2563eb",
        backgroundColor:"rgba(37,99,235,.15)",
        tension:.3,
        fill:true
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:true } },
      scales:{ y:{ beginAtZero:true, max:100 } }
    }
  });

  // Agrupar por dificuldade
  const buckets = { "F√°cil":[], "M√©dio":[], "Dif√≠cil":[] };
  phases.forEach(p => { if (buckets[p.difficulty]) buckets[p.difficulty].push(p); });

  const diffLabels = Object.keys(buckets);

  const avgCps = diffLabels.map(d => {
    const arr = buckets[d];
    if (!arr.length) return 0;
    const sum = arr.reduce((a,b)=>a+(Number(b.cps)||0), 0);
    return Number((sum/arr.length).toFixed(2));
  });

  const avgAcc = diffLabels.map(d => {
    const arr = buckets[d];
    if (!arr.length) return 0;
    const sum = arr.reduce((a,b)=>a+(Number(b.accuracyPct)||0), 0);
    return Math.round(sum/arr.length);
  });

  // 2) Velocidade
  speedChartInstance = new Chart(document.getElementById("speedChart"), {
    type:"bar",
    data:{
      labels: diffLabels,
      datasets:[{
        label:"CPS",
        data: avgCps,
        backgroundColor:"#16a34a"
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:true } },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  // 3) Precis√£o
  accuracyChartInstance = new Chart(document.getElementById("accuracyChart"), {
    type:"bar",
    data:{
      labels: diffLabels,
      datasets:[{
        label:"Precis√£o (%)",
        data: avgAcc,
        backgroundColor:"#f59e0b"
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:true } },
      scales:{ y:{ beginAtZero:true, max:100 } }
    }
  });
}
</script>

</body>
</html>
