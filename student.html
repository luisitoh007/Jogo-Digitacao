<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Detalhes do Aluno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‚úÖ Firebase (CORRETO) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- ‚úÖ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fa;margin:0}
    header{
      background:#1f2937;color:white;padding:16px 20px;
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;flex-wrap:wrap
    }
    header h2{margin:0;font-size:1.2rem}
    header .sub{font-size:.9rem;color:#d1d5db}
    header .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    header button{
      background:#2563eb;border:none;color:white;
      padding:8px 14px;border-radius:8px;cursor:pointer
    }
    header button.danger{background:#dc2626}
    header button.secondary{background:#0ea5e9}

    main{padding:20px}
    .card{background:white;border-radius:12px;padding:16px;margin-bottom:18px;
      box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:center}
    th{background:#f1f5f9}
    .pill{background:#f3f6ff;border:1px solid #d9e3ff;padding:6px 10px;border-radius:999px}
    .ok{color:#15803d;font-weight:bold}
    .bad{color:#b91c1c;font-weight:bold}
    .notice{
      margin-top:10px;padding:10px;border-radius:8px;
      background:#ecfeff;border:1px solid #bae6fd;color:#075985;
      white-space:pre-wrap;display:none
    }
  </style>
</head>

<body>

<header>
  <div>
    <h2 id="student-title">Aluno</h2>
    <div class="sub" id="student-sub"></div>
  </div>

  <div class="actions">
    <button id="recalcBtn" class="danger">üîÅ Recalcular notas</button>
    <button id="exportBtn" class="secondary">üì• Exportar CSV</button>
    <button onclick="history.back()">‚¨Ö Voltar</button>
  </div>
</header>

<main>
  <div class="card">
    <div class="pill">CPF: <span id="cpf"></span></div>
    <div class="pill">M√©dia: <span id="avg"></span>%</div>
    <div class="pill">Status: <span id="status"></span></div>
    <div id="notice" class="notice"></div>
  </div>

  <div class="grid">
    <div class="card"><canvas id="scoreChart"></canvas></div>
    <div class="card"><canvas id="speedChart"></canvas></div>
    <div class="card"><canvas id="accuracyChart"></canvas></div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Fase</th><th>Dificuldade</th><th>Nota</th>
          <th>Tempo</th><th>CPS</th><th>Precis√£o</th><th>Erros</th>
        </tr>
      </thead>
      <tbody id="phases-body"></tbody>
    </table>
  </div>
</main>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyCr81cMa2T_iZmxy2tNOjYydSnrs3aSmtk",
  authDomain:"jogo-digitacao.firebaseapp.com",
  projectId:"jogo-digitacao"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const uid = new URLSearchParams(location.search).get("uid");
let phasesCache=[], gradesCache=null;

function setStatus(ok){
  document.getElementById("status").innerHTML =
    ok ? "<span class='ok'>APROVADO</span>" : "<span class='bad'>EM ANDAMENTO</span>";
}

function capScoreByTimeTier(score, tier){
  const caps={fast:100,ideal:95,comfort:90,slow:80};
  return Math.min(score,caps[tier]??100);
}

function deriveTierByTime(p){
  const e=Number(p.elapsed);
  if(!isFinite(e)) return null;
  if(e<=p.targetFast) return "fast";
  if(e<=p.targetIdeal) return "ideal";
  if(e<=p.targetComfort) return "comfort";
  return "slow";
}

async function recalc(){
  let adjusted=0;
  for(const p of phasesCache){
    if(!p.targetComfort) continue;
    const tier=p.timeTier||deriveTierByTime(p);
    p.timeTier=tier;
    const n=capScoreByTimeTier(p.score,tier);
    if(n!==p.score){p.score=n;p.scoreAdjusted=true;adjusted++}
  }

  const avg=Math.round(phasesCache.reduce((a,b)=>a+b.score,0)/phasesCache.length);
  const approved=avg>=70;

  document.getElementById("avg").innerText=avg;
  setStatus(approved);

  await db.collection("grades").doc(uid).set({
    phases:phasesCache,average:avg,approved
  },{merge:true});

  document.getElementById("notice").style.display="block";
  document.getElementById("notice").innerText=
    `‚úÖ Recalculo conclu√≠do\n‚Ä¢ Fases ajustadas: ${adjusted}\n‚Ä¢ Nova m√©dia: ${avg}%`;

  render(phasesCache);
}

document.getElementById("recalcBtn").onclick=()=>confirm("Recalcular notas?")&&recalc();

auth.onAuthStateChanged(async u=>{
  const g=await db.collection("grades").doc(uid).get();
  phasesCache=g.data().phases;
  gradesCache=g.data();
  document.getElementById("avg").innerText=gradesCache.average;
  setStatus(gradesCache.approved);
  render(phasesCache);
});

function render(ph){
  document.getElementById("phases-body").innerHTML=
    ph.map(p=>`<tr>
      <td>${p.overallPhase}</td><td>${p.difficulty}</td>
      <td>${p.score}</td><td>${p.elapsed}</td>
      <td>${p.cps}</td><td>${p.accuracyPct}</td><td>${p.errors}</td>
    </tr>`).join("");
}
</script>

</body>
</html>
