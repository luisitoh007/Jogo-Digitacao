<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Digita√ß√£o Amig√°vel</title>
    <style>
        /* =========================================
           CSS: ESTILOS VISUAIS E ACESSIBILIDADE
           ========================================= */
        :root {
            --bg-color: #e6f2ff;
            --text-color: #333333;
            --success-color: #d4edda;
            --error-color: #f8d7da;
            --primary-btn: #4CAF50;
            --secondary-btn: #FF9800;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: background-color 0.3s;
        }

        body.flash-green { background-color: var(--success-color); }
        body.flash-red { background-color: var(--error-color); }

        header {
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1, h2 { margin: 10px 0; }

        .progress-container {
            width: 80%;
            max-width: 600px;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px auto;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            transition: width 0.4s ease;
        }

        .stars { font-size: 2rem; margin-top: 10px; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* O truque do input oculto para resolver o bug do Mac/Acentos */
        #hidden-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        #text-display {
            font-size: 3rem;
            letter-spacing: 2px;
            background: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            word-wrap: break-word;
            max-width: 90%;
            max-height: 40vh;
            overflow-y: auto;
            text-align: left;
            line-height: 1.5;
            cursor: text; /* Indica que √© clic√°vel */
        }

        .char { color: #ccc; }
        .char.correct { color: #28a745; font-weight: bold; }
        .char.current { color: #007bff; text-decoration: underline; font-weight: bold; background-color: #e6f2ff; }

        button {
            font-size: 1.5rem;
            padding: 15px 40px;
            background-color: var(--primary-btn);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin: 10px;
        }

        #change-text-btn { background-color: var(--secondary-btn); display: none; }
        #feedback-msg { font-size: 1.5rem; font-weight: bold; height: 2rem; color: #555; margin-bottom: 10px; }
    </style>
</head>
<body>

    <header>
        <h2>Fase <span id="phase-number">1</span>: <span id="phase-name">O B√°sico</span></h2>
        <div class="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>
        <div class="stars" id="stars-display">‚≠ê‚≠ê‚≠ê</div>
    </header>

    <main>
        <p id="feedback-msg">Clique em "Come√ßar" para iniciar!</p>
        
        <input type="text" id="hidden-input" autocomplete="off" spellcheck="false">
        
        <div id="text-display" onclick="document.getElementById('hidden-input').focus()"></div>
        
        <div>
            <button id="action-btn" onclick="startGame()">Come√ßar</button>
            <button id="change-text-btn" onclick="loadPhaseFinalText()">Trocar Texto</button>
        </div>
    </main>

    <script>
        /* =========================================
           JAVASCRIPT: DADOS E L√ìGICA
           ========================================= */
        
        // Fun√ß√£o para embaralhar os arrays (Tornar o jogo aleat√≥rio sempre)
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // 1. Bancos de Palavras Expandidos
        // Adicionei v√°rias palavras, o sistema vai embaralhar e pegar apenas uma quantidade X por fase.
        const poolVowels = ["A", "E", "I", "O", "U"];
        const poolConsonants = ["B", "C", "D", "F", "G", "H", "J", "K", "L", "M", "N", "P", "Q", "R", "S", "T", "V", "X", "Z"];
        const poolShortWords = ["PAI", "MAE", "VO", "TIA", "TIO", "BEM", "MAL", "SIM", "NAO", "SOL", "LUA", "DIA", "PAZ", "LUZ", "MAR", "COR"];
        const poolMediumWords = ["MESA", "CASA", "BOLO", "CAFE", "GATO", "RATO", "DOCE", "AGUA", "FOGO", "TERRA", "VENTO", "LIVRO", "LETRA", "TEMPO", "NOITE"];
        const poolLongWords = ["CACHORRO", "MERCADO", "TELEFONE", "COMPUTADOR", "INTERNET", "FAMILIA", "TRABALHO", "NATUREZA", "ESPERANCA", "FELICIDADE", "AMIZADE"];
        const poolPhrases = [
            "Bom dia, tudo bem?", "Meu nome √© Maria.", "Eu gosto de cafe.", 
            "O dia esta lindo hoje.", "Vamos aprender a digitar.", "A pratica leva a perfeicao.",
            "O cachorro latiu alto.", "Fui ao mercado comprar pao.", "A internet nos conecta."
        ];

        // Textos Liter√°rios (Fase Final)
        const literaryTexts = [
            "Marcela amou-me durante quinze meses e onze contos de r√©is; nada menos.", 
            "O poeta √© um fingidor. Finge t√£o completamente que chega a fingir que √© dor a dor que deveras sente.", 
            "Renda-se, como eu me rendi. Mergulhe no que voc√™ n√£o conhece como eu mergulhei.", 
            "O correr da vida embrulha tudo. A vida √© assim: esquenta e esfria, aperta e da√≠ afrouxa.", 
            "O sertanejo √©, antes de tudo, um forte. N√£o tem o raquitismo exaustivo dos mesti√ßos.", 
            "Tudo vale a pena se a alma n√£o √© pequena. Quem quer passar al√©m do Bojador tem que passar al√©m da dor.",
            "As pessoas n√£o s√£o m√°s, elas s√≥ est√£o perdidas. O tempo √© o melhor autor; sempre encontra um final perfeito."
        ];

        // Criando as fases dinamicamente
        let phases = [];

        function buildPhases() {
            // Pegamos quantidades aleat√≥rias do banco para cada partida
            phases = [
                { name: "Fase 1: Vogais", words: shuffle([...poolVowels]) }, // Pega todas as vogais embaralhadas
                { name: "Fase 2: Consoantes", words: shuffle([...poolConsonants]).slice(0, 8) }, // 8 consoantes aleat√≥rias
                { name: "Fase 3: Palavras Curtas", words: shuffle([...poolShortWords]).slice(0, 10) }, // 10 palavras curtas
                { name: "Fase 4: Palavras M√©dias", words: shuffle([...poolMediumWords]).slice(0, 10) },
                { name: "Fase 5: Palavras Longas", words: shuffle([...poolLongWords]).slice(0, 10) },
                { name: "Fase 6: Frases", words: shuffle([...poolPhrases]).slice(0, 5) },
                { name: "Fase Final: Texto Liter√°rio", words: [] } // O texto ser√° gerido √† parte
            ];
        }

        // 2. Vari√°veis de Estado
        let currentPhaseIndex = 0;
        let currentWordIndex = 0;
        let currentText = "";
        let charIndex = 0;
        let errors = 0;
        let isPlaying = false;

        const textDisplay = document.getElementById("text-display");
        const hiddenInput = document.getElementById("hidden-input");
        const feedbackMsg = document.getElementById("feedback-msg");
        const actionBtn = document.getElementById("action-btn");
        const changeTextBtn = document.getElementById("change-text-btn");
        const progress = document.getElementById("progress");
        const starsDisplay = document.getElementById("stars-display");
        const phaseNumber = document.getElementById("phase-number");
        const phaseName = document.getElementById("phase-name");

        // 3. Inicializa√ß√£o
        function startGame() {
            buildPhases(); // Constr√≥i as fases aleat√≥rias
            isPlaying = true;
            errors = 0;
            currentPhaseIndex = 0;
            currentWordIndex = 0;
            actionBtn.style.display = "none";
            feedbackMsg.innerText = "Digite a letra sublinhada.";
            hiddenInput.focus(); // Foca no input escondido
            loadWord();
            updateUI();
        }

        function loadWord() {
            if (currentPhaseIndex === phases.length - 1) { // √öltima fase
                loadPhaseFinalText();
            } else {
                currentText = phases[currentPhaseIndex].words[currentWordIndex];
                renderText();
            }
            hiddenInput.value = ""; // Limpa o input escondido
        }

        function loadPhaseFinalText() {
            const randomIndex = Math.floor(Math.random() * literaryTexts.length);
            currentText = literaryTexts[randomIndex];
            renderText();
            changeTextBtn.style.display = "inline-block";
            phaseName.innerText = "O Mestre da Digita√ß√£o";
            hiddenInput.focus();
        }

        function renderText() {
            charIndex = 0;
            textDisplay.innerHTML = "";
            for (let i = 0; i < currentText.length; i++) {
                const span = document.createElement("span");
                span.innerText = currentText[i];
                span.classList.add("char");
                if (i === 0) span.classList.add("current");
                textDisplay.appendChild(span);
            }
        }

        function updateUI() {
            phaseNumber.innerText = currentPhaseIndex + 1;
            
            if (currentPhaseIndex < phases.length - 1) {
                phaseName.innerText = phases[currentPhaseIndex].name;
                const totalWords = phases[currentPhaseIndex].words.length;
                const progressPercent = (currentWordIndex / totalWords) * 100;
                progress.style.width = progressPercent + "%";
            } else {
                progress.style.width = "0%";
            }
        }

        function updateFinalProgress() {
            if (currentPhaseIndex === phases.length - 1) {
                const progressPercent = (charIndex / currentText.length) * 100;
                progress.style.width = progressPercent + "%";
            }
        }

        function flashScreen(type) {
            document.body.classList.add(`flash-${type}`);
            setTimeout(() => document.body.classList.remove(`flash-${type}`), 300);
        }

        // 4. Capturando a Digita√ß√£o Real (Lidando com Mac e Acentos)
        // Usamos 'input' no campo escondido. Ele s√≥ dispara quando o caractere final √© formado (ex: ~ + a = √£).
        hiddenInput.addEventListener("input", (event) => {
            if (!isPlaying) {
                hiddenInput.value = "";
                return;
            }

            // Pega a √∫ltima letra que entrou no input
            const typedVal = hiddenInput.value;
            const typedChar = typedVal.slice(-1); 
            
            if (!typedChar) return; // Se apagou algo, ignora

            const expectedChar = currentText[charIndex];
            const spans = textDisplay.querySelectorAll("span");
            
            let isCorrect = false;

            // Valida√ß√£o
            if (currentPhaseIndex === phases.length - 1) {
                isCorrect = (typedChar === expectedChar); // √öltima fase exige exatid√£o de mai√∫sculas e acentos
            } else {
                // Fases anteriores ignoram acentos complexos e mai√∫sculas para facilitar
                // Compara removendo acentos da expectativa se necess√°rio, ou s√≥ min√∫sculas
                isCorrect = (typedChar.toLowerCase() === expectedChar.toLowerCase()); 
            }

            if (isCorrect) {
                spans[charIndex].classList.remove("current");
                spans[charIndex].classList.add("correct");
                flashScreen("green");
                charIndex++;
                updateFinalProgress();

                if (charIndex === currentText.length) {
                    if (currentPhaseIndex === phases.length - 1) {
                        finishPhase();
                    } else {
                        currentWordIndex++;
                        if (currentWordIndex >= phases[currentPhaseIndex].words.length) {
                            finishPhase();
                        } else {
                            isPlaying = false;
                            setTimeout(() => {
                                loadWord();
                                updateUI();
                                isPlaying = true;
                            }, 400);
                        }
                    }
                } else {
                    spans[charIndex].classList.add("current");
                    spans[charIndex].scrollIntoView({ behavior: "smooth", block: "center" });
                }
            } else {
                errors++;
                flashScreen("red");
                if (currentPhaseIndex === phases.length - 1) {
                    feedbackMsg.innerText = "Aten√ß√£o a mai√∫sculas, min√∫sculas e acentos!";
                }
            }
            
            // Mantemos o input limpo para n√£o pesar
            hiddenInput.value = ""; 
        });

        // Garantir que o input escondido mantenha o foco se o usu√°rio clicar na tela
        document.body.addEventListener("click", () => {
            if(isPlaying) hiddenInput.focus();
        });

        function calculateStars() {
            if (errors <= 2) return "‚≠ê‚≠ê‚≠ê Excelente!";
            if (errors <= 6) return "‚≠ê‚≠ê Muito bom!";
            return "‚≠ê Continue praticando!";
        }

        function finishPhase() {
            isPlaying = false;
            progress.style.width = "100%";
            starsDisplay.innerText = calculateStars();
            
            currentPhaseIndex++;
            currentWordIndex = 0;
            errors = 0;
            changeTextBtn.style.display = "none";

            if (currentPhaseIndex >= phases.length) {
                feedbackMsg.innerText = "Parab√©ns! Voc√™ se tornou um Mestre da Digita√ß√£o!";
                textDisplay.innerHTML = "üèÜüéâüéì";
                textDisplay.style.textAlign = "center";
                actionBtn.innerText = "Jogar Tudo Novamente";
                actionBtn.onclick = () => location.reload();
            } else {
                feedbackMsg.innerText = "Fase conclu√≠da! " + calculateStars();
                actionBtn.innerText = "Pr√≥xima Fase";
                textDisplay.innerHTML = "üåü";
            }
            
            actionBtn.style.display = "inline-block";
        }
    </script>
</body>
</html>
