<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Login - Exercício de Digitação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKs (Compat) -->
<!-- Firebase SDKs (OBRIGATÓRIO assim) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #e6f2ff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .login-box {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 4px 10px rgba(0,0,0,.15);
      text-align: center;
    }
    h2 { margin-bottom: 16px; }
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      font-size: 1.1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .error {
      color: #b00020;
      margin-top: 10px;
      font-size: .95rem;
      white-space: pre-wrap;
      text-align: left;
    }
    .hint {
      color: #555;
      font-size: .9rem;
      margin-top: 8px;
      text-align: left;
    }
  </style>
</head>

<body>

<div class="login-box">
  <h2>Login</h2>

  <input id="name" placeholder="Nome completo" />
  <input id="cpf" placeholder="CPF (somente números)" inputmode="numeric" />
  <input id="password" type="password" placeholder="Senha (mínimo 6 caracteres)" />

  <button onclick="login()">Entrar</button>

  <div class="hint">
    Dica: se for o primeiro acesso, ele cria a conta automaticamente.
  </div>

  <div class="error" id="error"></div>
</div>

<script>
/* ==================================================
   CONFIG FIREBASE (COLE A SUA AQUI)
   ================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyCr81cMa2T_iZmxy2tNOjYydSnrs3aSmtk",
  authDomain: "jogo-digitacao.firebaseapp.com",
  projectId: "jogo-digitacao",
  appId: "1:903019411681:web:ea572018fb9913ca2f9fa0"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ==================================================
   UTIL: VALIDAR CPF (MÓDULO 11)
   ================================================== */
function validarCPF(cpf) {
  cpf = cpf.replace(/\D/g, "");
  if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

  let soma = 0;
  for (let i = 0; i < 9; i++) soma += cpf[i] * (10 - i);
  let resto = (soma * 10) % 11;
  if (resto === 10) resto = 0;
  if (resto != cpf[9]) return false;

  soma = 0;
  for (let i = 0; i < 10; i++) soma += cpf[i] * (11 - i);
  resto = (soma * 10) % 11;
  if (resto === 10) resto = 0;
  return resto == cpf[10];
}

/* ==================================================
   LOGIN / CADASTRO
   ================================================== */
async function login() {
  const nome = document.getElementById("name").value.trim();
  const cpfRaw = document.getElementById("cpf").value.trim();
  const senha = document.getElementById("password").value;
  const errorBox = document.getElementById("error");
  errorBox.innerText = "";

  if (!nome || !cpfRaw || !senha) {
    errorBox.innerText = "Preencha todos os campos.";
    return;
  }
  if (senha.length < 6) {
    errorBox.innerText = "A senha precisa ter no mínimo 6 caracteres.";
    return;
  }
  if (!validarCPF(cpfRaw)) {
    errorBox.innerText = "CPF inválido.";
    return;
  }

  const cpf = cpfRaw.replace(/\D/g, "");
  const email = cpf + "@alunos.local";

  try {
    // 1) tenta logar
    const cred = await auth.signInWithEmailAndPassword(email, senha);
    await afterLogin(cred.user);
    return;
  } catch (err) {
    // 2) com email enumeration protection, user-not-found pode virar invalid-credential
    if (err.code === "auth/invalid-credential" || err.code === "auth/user-not-found") {
      try {
        // tenta criar usuário
        const cred = await auth.createUserWithEmailAndPassword(email, senha);

        await db.collection("users").doc(cred.user.uid).set({
          nome,
          cpf,
          role: "student",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await afterLogin(cred.user);
        return;

      } catch (createErr) {
        // se já existe, então é senha errada (ou tentativa repetida)
        if (createErr.code === "auth/email-already-in-use") {
          errorBox.innerText = "Este CPF já está cadastrado. Senha incorreta.";
          return;
        }
        if (createErr.code === "auth/operation-not-allowed") {
          errorBox.innerText = "Email/Senha não está habilitado no Firebase Auth (Sign-in method).";
          return;
        }
        errorBox.innerText =
          "Falha ao criar conta.\n" +
          `Código: ${createErr.code}\n` +
          `Mensagem: ${createErr.message}`;
        return;
      }
    }

    // outros erros
    errorBox.innerText =
      "Falha no login.\n" +
      `Código: ${err.code}\n` +
      `Mensagem: ${err.message}`;
  }
}
  
/* ==================================================
   PÓS LOGIN: ALUNO OU PROFESSOR
   ================================================== */
async function afterLogin(user) {
  const doc = await db.collection("users").doc(user.uid).get();

  if (!doc.exists) {
    // Se por algum motivo não criou o perfil, cria como aluno
    await db.collection("users").doc(user.uid).set({
      nome: "Sem nome",
      cpf: "desconhecido",
      role: "student",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  }

  const data = (await db.collection("users").doc(user.uid).get()).data();

  if (data.role === "teacher") {
    window.location.href = "prof.html";
  } else {
    window.location.href = "jogo.html";
  }
}
</script>

</body>
</html>
